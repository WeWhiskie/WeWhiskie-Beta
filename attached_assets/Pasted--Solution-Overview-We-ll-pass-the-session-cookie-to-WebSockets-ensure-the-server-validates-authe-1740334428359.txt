ğŸŒŸ Solution Overview:
We'll pass the session cookie to WebSockets, ensure the server validates authentication, and implement a secure reconnection strategy.

ğŸš€ Step 1: Modify WebSocket Client to Send Auth Token
Your frontend WebSocket connection is likely missing the authentication header. Instead of the basic connection:

javascript
Copy
Edit
const socket = new WebSocket("wss://your-replit-url");
Use this:

javascript
Copy
Edit
const socket = new WebSocket(`wss://your-replit-url?token=${document.cookie}`);
âœ… This appends session cookies as a query parameter.

ğŸš€ Step 2: Update WebSocket Server to Extract Authentication
Modify your server/routes.ts to extract the authentication token:

typescript
Copy
Edit
import { Server } from "socket.io";
import cookie from "cookie";
import session from "express-session";

const io = new Server(3001, {
    cors: {
        origin: "*",
        methods: ["GET", "POST"]
    }
});

io.use((socket, next) => {
    try {
        const cookies = cookie.parse(socket.handshake.headers.cookie || "");
        if (!cookies["whisky.session.id"]) {
            console.log("âŒ No session cookie found!");
            return next(new Error("Unauthorized"));
        }
        console.log("âœ… WebSocket Authenticated:", cookies["whisky.session.id"]);
        next();
    } catch (err) {
        next(new Error("Authentication Error"));
    }
});

io.on("connection", (socket) => {
    console.log(`ğŸ”— New WebSocket Client: ${socket.id}`);

    socket.on("disconnect", () => {
        console.log(`âŒ Client Disconnected: ${socket.id}`);
    });

    socket.on("message", (data) => {
        console.log(`ğŸ“© Message received: ${data}`);
        socket.send("Message received!");
    });
});
âœ… This ensures WebSockets authenticate using session cookies.

ğŸš€ Step 3: Fix CORS for WebSocket Authentication
Modify your Express session settings in server/routes.ts to explicitly allow cookies for WebSockets:

typescript
Copy
Edit
app.use(
    session({
        secret: "your-secret-key",
        resave: false,
        saveUninitialized: true,
        cookie: {
            secure: false,  // Set to true if using HTTPS
            httpOnly: false, // Allow WebSocket access
            sameSite: "lax"
        }
    })
);
âœ… This allows session cookies to be accessible to WebSockets.

ğŸš€ Step 4: Implement Auto-Reconnection in Frontend
If authentication fails or the WebSocket drops, implement automatic reconnection:

javascript
Copy
Edit
let socket;
function connectWebSocket() {
    socket = new WebSocket(`wss://your-replit-url?token=${document.cookie}`);

    socket.onopen = () => {
        console.log("âœ… WebSocket connected");
    };

    socket.onerror = (error) => {
        console.error("âŒ WebSocket error:", error);
    };

    socket.onclose = (event) => {
        console.warn("âš ï¸ WebSocket closed, reconnecting in 5 seconds...");
        setTimeout(connectWebSocket, 5000);
    };
}

connectWebSocket();
âœ… This ensures WebSocket reconnects when it disconnects.

ğŸš€ Step 5: Debug WebSocket Connection
Once you deploy the changes:

1ï¸âƒ£ Check the Server Logs
Run this in Replitâ€™s Shell to monitor WebSocket logs:

sh
Copy
Edit
npm run dev
You should see ğŸ”— WebSocket Authenticated: with session details.

2ï¸âƒ£ Inspect Browser Console

Open Developer Tools (F12 â†’ Console & Network â†’ WS tab).
Look for any WebSocket authentication errors.
ğŸ¯ Final Debugging Checklist
âœ… Frontend WebSocket URL includes session token (?token=${document.cookie}).
âœ… WebSocket server extracts session cookies (socket.handshake.headers.cookie).
âœ… Express session settings allow WebSocket authentication.
âœ… Auto-reconnection handles connection drops.